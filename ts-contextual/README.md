Re-implementation with a Contextual monad similar to "Type inference in context".
